---
import {PackageIcon, StarIcon, DownloadIcon} from 'astro-feather';
import {t} from 'i18next'

const githubAuth = import.meta.env.GITHUB_AUTH

const reposResponse = await fetch('https://api.github.com/users/thisisleobro/repos', {headers: {Authorization: githubAuth}});
const githubRepos = await reposResponse.json();

const repos = await Promise.all(githubRepos.map(async (repo: any) => {
	const releasesResponse = await fetch(`https://api.github.com/repos/thisisleobro/${repo.name}/releases`, {headers: {Authorization: githubAuth}})

	const releases = await releasesResponse.json()

	const downloads = releases.reduce((downloadsNumber: any, release: any) => {
		return downloadsNumber + release.assets.reduce((assetsDownloadsNumber: any, assets: any) => {
			return assetsDownloadsNumber + assets.download_count
		}, 0)
	}, 0)

	return {...repo, downloads}
}));

---
<section id="repos" class="flex flex-col align-middle gap-12 max-w-3xl mx-auto m-24">
	<div class="flex flex-col gap-2">
		<h2 class="text-xl font-semibold text-center pt-4">
			{t('repos.title')}
		</h2>
		<h3 class="text-lg text-center text-gray-600">
			{t('repos.subtitle')}
		</h3>
	</div>
	<ul id="github-repos" class="flex flex-col gap-8">
		{repos
		.filter((repo) => !repo.fork)
		.map((repo) => <li class="flex flex-col gap-2">
			<div class="flex justify-between">
				<a href={repo.html_url} class="flex items-center gap-2">
					<PackageIcon customClasses='size-4' /> {repo.name}
				</a>
				<div class="flex gap-4">
					{repo.downloads > 0 && <div class="flex justify-between items-center gap-1">
						<DownloadIcon customClasses='size-4'/> {repo.downloads}
					</div>}

					{repo.stargazers_count > 0 && <div class="flex justify-between items-center gap-1">
						<StarIcon customClasses='size-4'/> {repo.stargazers_count}
					</div>}
				</div> 
			</div>
			<p>{repo.description ?? '...'}</p>
		</li>)}
	</ul>
</section>
